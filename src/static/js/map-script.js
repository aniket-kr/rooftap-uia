const mapping = [
    {
      "date": "8/24/2022",
      "terrestrialRads": 557.125
    },
    {
      "date": "8/25/2022",
      "terrestrialRads": 562.325
    },
    {
      "date": "8/26/2022",
      "terrestrialRads": 567.55
    },
    {
      "date": "8/27/2022",
      "terrestrialRads": 572.8583333
    },
    {
      "date": "8/28/2022",
      "terrestrialRads": 578.1833333
    },
    {
      "date": "8/29/2022",
      "terrestrialRads": 583.6333333
    },
    {
      "date": "8/30/2022",
      "terrestrialRads": 589.125
    },
    {
      "date": "8/31/2022",
      "terrestrialRads": 594.6
    },
    {
      "date": "9/1/2022",
      "terrestrialRads": 600.0333333
    },
    {
      "date": "9/2/2022",
      "terrestrialRads": 605.4666667
    },
    {
      "date": "9/3/2022",
      "terrestrialRads": 611.0083333
    },
    {
      "date": "9/4/2022",
      "terrestrialRads": 616.525
    },
    {
      "date": "9/5/2022",
      "terrestrialRads": 622.0583333
    },
    {
      "date": "9/6/2022",
      "terrestrialRads": 627.55
    },
    {
      "date": "9/7/2022",
      "terrestrialRads": 633.025
    },
    {
      "date": "9/8/2022",
      "terrestrialRads": 638.575
    },
    {
      "date": "9/9/2022",
      "terrestrialRads": 644.1416667
    },
    {
      "date": "9/10/2022",
      "terrestrialRads": 649.6666667
    },
    {
      "date": "9/11/2022",
      "terrestrialRads": 604.8384615
    },
    {
      "date": "9/12/2022",
      "terrestrialRads": 610.0384615
    },
    {
      "date": "9/13/2022",
      "terrestrialRads": 615.3076923
    },
    {
      "date": "9/14/2022",
      "terrestrialRads": 620.5538462
    },
    {
      "date": "9/15/2022",
      "terrestrialRads": 625.7615385
    },
    {
      "date": "9/16/2022",
      "terrestrialRads": 630.9615385
    },
    {
      "date": "9/17/2022",
      "terrestrialRads": 636.1538462
    },
    {
      "date": "9/18/2022",
      "terrestrialRads": 641.3384615
    },
    {
      "date": "9/19/2022",
      "terrestrialRads": 646.4923077
    },
    {
      "date": "9/20/2022",
      "terrestrialRads": 651.6230769
    },
    {
      "date": "9/21/2022",
      "terrestrialRads": 656.7307692
    },
    {
      "date": "9/22/2022",
      "terrestrialRads": 661.8076923
    },
    {
      "date": "9/23/2022",
      "terrestrialRads": 666.8846154
    },
    {
      "date": "9/24/2022",
      "terrestrialRads": 671.9307692
    },
    {
      "date": "9/25/2022",
      "terrestrialRads": 676.9384615
    },
    {
      "date": "9/26/2022",
      "terrestrialRads": 681.9230769
    },
    {
      "date": "9/27/2022",
      "terrestrialRads": 686.8692308
    },
    {
      "date": "9/28/2022",
      "terrestrialRads": 691.8153846
    },
    {
      "date": "9/29/2022",
      "terrestrialRads": 696.8
    },
    {
      "date": "9/30/2022",
      "terrestrialRads": 701.9307692
    },
    {
      "date": "10/1/2022",
      "terrestrialRads": 707.0230769
    },
    {
      "date": "10/2/2022",
      "terrestrialRads": 712.1384615
    },
    {
      "date": "10/3/2022",
      "terrestrialRads": 717.1846154
    },
    {
      "date": "10/4/2022",
      "terrestrialRads": 722.2
    },
    {
      "date": "10/5/2022",
      "terrestrialRads": 727.1769231
    },
    {
      "date": "10/6/2022",
      "terrestrialRads": 732.1153846
    },
    {
      "date": "10/7/2022",
      "terrestrialRads": 684.5142857
    },
    {
      "date": "10/8/2022",
      "terrestrialRads": 689.2
    },
    {
      "date": "10/9/2022",
      "terrestrialRads": 693.8642857
    },
    {
      "date": "10/10/2022",
      "terrestrialRads": 698.5
    },
    {
      "date": "10/11/2022",
      "terrestrialRads": 703.0928571
    },
    {
      "date": "10/12/2022",
      "terrestrialRads": 707.6714286
    },
    {
      "date": "10/13/2022",
      "terrestrialRads": 712.1571429
    },
    {
      "date": "10/14/2022",
      "terrestrialRads": 716.5785714
    },
    {
      "date": "10/15/2022",
      "terrestrialRads": 721
    },
    {
      "date": "10/16/2022",
      "terrestrialRads": 725.3642857
    },
    {
      "date": "10/17/2022",
      "terrestrialRads": 729.7214286
    },
    {
      "date": "10/18/2022",
      "terrestrialRads": 733.9785714
    },
    {
      "date": "10/19/2022",
      "terrestrialRads": 738.1428571
    },
    {
      "date": "10/20/2022",
      "terrestrialRads": 742.2857143
    },
    {
      "date": "10/21/2022",
      "terrestrialRads": 746.4357143
    },
    {
      "date": "10/22/2022",
      "terrestrialRads": 750.5357143
    },
    {
      "date": "10/23/2022",
      "terrestrialRads": 754.4642857
    },
    {
      "date": "10/24/2022",
      "terrestrialRads": 758.35
    },
    {
      "date": "10/25/2022",
      "terrestrialRads": 762.2
    },
    {
      "date": "10/26/2022",
      "terrestrialRads": 766.05
    },
    {
      "date": "10/27/2022",
      "terrestrialRads": 769.8428571
    },
    {
      "date": "10/28/2022",
      "terrestrialRads": 773.4928571
    },
    {
      "date": "10/29/2022",
      "terrestrialRads": 777.1357143
    },
    {
      "date": "10/30/2022",
      "terrestrialRads": 780.7071429
    },
    {
      "date": "10/31/2022",
      "terrestrialRads": 784.2642857
    },
    {
      "date": "11/1/2022",
      "terrestrialRads": 787.8
    },
    {
      "date": "11/2/2022",
      "terrestrialRads": 791.1214286
    },
    {
      "date": "11/3/2022",
      "terrestrialRads": 794.4071429
    },
    {
      "date": "11/4/2022",
      "terrestrialRads": 797.6428571
    },
    {
      "date": "11/5/2022",
      "terrestrialRads": 800.8714286
    },
    {
      "date": "11/6/2022",
      "terrestrialRads": 804.0571429
    },
    {
      "date": "11/7/2022",
      "terrestrialRads": 807.0714286
    },
    {
      "date": "11/8/2022",
      "terrestrialRads": 810.0214286
    },
    {
      "date": "11/9/2022",
      "terrestrialRads": 812.9428571
    },
    {
      "date": "11/10/2022",
      "terrestrialRads": 815.8357143
    },
    {
      "date": "11/11/2022",
      "terrestrialRads": 818.7428571
    },
    {
      "date": "11/12/2022",
      "terrestrialRads": 821.5785714
    },
    {
      "date": "11/13/2022",
      "terrestrialRads": 824.3785714
    },
    {
      "date": "11/14/2022",
      "terrestrialRads": 827.1357143
    },
    {
      "date": "11/15/2022",
      "terrestrialRads": 829.8571429
    },
    {
      "date": "11/16/2022",
      "terrestrialRads": 832.5857143
    },
    {
      "date": "11/17/2022",
      "terrestrialRads": 835.1
    },
    {
      "date": "11/18/2022",
      "terrestrialRads": 837.55
    },
    {
      "date": "11/19/2022",
      "terrestrialRads": 839.9571429
    },
    {
      "date": "11/20/2022",
      "terrestrialRads": 842.3642857
    },
    {
      "date": "11/21/2022",
      "terrestrialRads": 844.75
    },
    {
      "date": "11/22/2022",
      "terrestrialRads": 846.8785714
    },
    {
      "date": "11/23/2022",
      "terrestrialRads": 848.9714286
    },
    {
      "date": "11/24/2022",
      "terrestrialRads": 794.4133333
    },
    {
      "date": "11/25/2022",
      "terrestrialRads": 796.4533333
    },
    {
      "date": "11/26/2022",
      "terrestrialRads": 798.4933333
    },
    {
      "date": "11/27/2022",
      "terrestrialRads": 800.3
    },
    {
      "date": "11/28/2022",
      "terrestrialRads": 802.0666667
    },
    {
      "date": "11/29/2022",
      "terrestrialRads": 803.8133333
    },
    {
      "date": "11/30/2022",
      "terrestrialRads": 805.54
    }
  ]


function randomSelection(arr) {
    const idx = (Math.random() * 100003131313) % arr.length;
    return arr[Math.round(idx)];
}

function round(num, n) {
    const newNum = num * Math.pow(10, n);
    Math.round(newNum);
    return newNum / Math.pow(10, n);
}

function fillSidebar(building) {
    const area = document.querySelector('#area');
    const paint = document.querySelector('#paint');
    const dailySavings = document.querySelector('#daily-savings');
    const monthlySavings = document.querySelector('#monthly-savings');
    const yearlySavings = document.querySelector('#yearly-savings');
    const monthlyCostSavings = document.querySelector('#monthly-cost-savings');
    const yearlyCostSavings = document.querySelector('#yearly-cost-savings');
    const emission = document.querySelector('#emission')

    area.innerHTML = building.area;
    paint.innerHTML = randomSelection(['#f0f5f5', '#e1eaea', '#d1e0e0', '#c2d6d6', '#b3cbcb']);
    const dailySavs = getDailySavings();
    console.log(dailySavs)
    dailySavings.innerHTML = dailySavs.toFixed(3);
    monthlySavings.innerHTML = (dailySavs * 30).toFixed(3);
    yearlySavings.innerHTML = (dailySavs * 365).toFixed(3);

    monthlyCostSavings.innerHTML = getMonthlyCostSavings().toFixed(3);
    yearlyCostSavings.innerHTML = (getMonthlyCostSavings() * 12).toFixed(3);

    emission.innerHTML = ((1 + Math.random()) * 365).toFixed(3);
}


function getDailySavings() {
    return 0.2 * 794 * 0.25 * 50 / 2.445;
}

function getMonthlyCostSavings() {
    return getDailySavings() * 30 * 0.148 * 17.03;
}

async function fetchBuildings(url) {
    const request = await fetch(url);
    const buildings = await request.json();
    return buildings;
}

function drawPolygon(coords) {
    const polygon = new google.maps.Polygon({
        paths: coords,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 1,
        fillColor: '#FF0000',
        fillOpacity: 0.25,
      });
    return polygon;
}


function initMap() {
    const bar = document.querySelector('span.bar');
    bar.addEventListener('click', (e) => {
        const sidebar = document.querySelector('.slide-bar');
        if (sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        } else {
            sidebar.classList.add('active');
        }
    })
    
    const options = {
        zoom: 25,
        center: { lat: -34.16644556429744, lng: 24.828156701270824 },
        mapTypeId: 'satellite',
        disableDefaultUI: true
    };
    const map = new google.maps.Map(document.querySelector('#map'), options);

    fetchBuildings('/building').then(buildings => {
        buildings.forEach(building => {
            const final = building.shape.coordinates[0].map(coord => { return { lat: coord[1], lng: coord[0] }; });
            const polygon = drawPolygon(final)
            polygon.setMap(map);

            google.maps.event.addListener(polygon, 'click', function (e) {
                const sidebar = document.querySelector('.slide-bar')
                sidebar.classList.add('active')
                fillSidebar(building);
              });
        });
    });

    // search bar - autocomplete API
    const input = document.querySelector('#searchbox')
    const autocomplete = new google.maps.places.Autocomplete(input);

    google.maps.event.addListener(autocomplete, 'place_changed', () => {
      const place = autocomplete.getPlace();
      const location = place.geometry.location;
      map.setCenter(new google.maps.LatLng(location.lat(), location.lng()));
      fetchBuildings(`/building?lat=${location.lat()}&lng=${location.lng()}`).then(buildings => {
        buildings.forEach(building => {
          const final = building.shape.coordinates[0].map(coord => { return { lat: coord[1], lng: coord[0] }; });
          const polygon = drawPolygon(final)
          polygon.setMap(map);

          google.maps.event.addListener(polygon, 'click', function (e) {
              const sidebar = document.querySelector('.slide-bar')
              sidebar.classList.add('active')
              fillSidebar(building);
            });
      });
      });
    });
}

window.initMap = initMap;
